package ethtxmanager

import (
	"context"
	"math/big"
	"testing"
	"time"

	"github.com/0xPolygonHermez/zkevm-node/hex"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/google/uuid"
)

func TestClient_postSignRequestAndWaitResult(t *testing.T) {
	client := &Client{
		cfg: Config{
			CustodialAssetsConfig: CustodialAssetsConfig{
				Enable:            false,
				URL:               "http://asset-onchain.base-defi.svc.test.local:7001",
				Symbol:            2882,
				SequencerAddr:     common.HexToAddress("d6dda5aa7749142b7fda3fe4662c9f346101b8a6"),
				AggregatorAddr:    common.HexToAddress("b0950cd623392424f8687bd4f46df204790d19dd"),
				WaitResultTimeout: 2 * time.Minute,
			},
		},
	}
	ctx := context.WithValue(context.Background(), traceID, uuid.New().String())
	txInput, _ := hex.DecodeHex("0xe91cbddf00000000000000000000000000000000000000000000000000000000000000600000000000000000000000005e7b89ab3b2de21f0f35da4920b9d7310ccbe2590000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000007c0000000000000000000000000000000000000000000000000000000000000088000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000ac00000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000e800000000000000000000000000000000000000000000000000000000000000f40000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010c000000000000000000000000000000000000000000000000000000000000000a083092a609e8282b91e3e74be90b683a8ef48006e97f1322d05c37d78aa49f993d80054f00a5b4667f4cadaff8beb95b7338f6aa9715b805740a987d8b2d32c07000000000000000000000000000000000000000000000000000000006597c8fe0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a004c57cf4266a5f6981a94a2268de3f96fae8b742b2ede9b8a94b2229b6d38bb58676f38679ce90a3985618ac80aa13e6df305b9d94a10c22df5ee33b3519c90c000000000000000000000000000000000000000000000000000000006597c9100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a06f019d940d52c01cc51cffe0ca3f4fc3297aebf80090ca5227f3bcd1d93c48f08676f38679ce90a3985618ac80aa13e6df305b9d94a10c22df5ee33b3519c90c000000000000000000000000000000000000000000000000000000006597c91c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0f0702ce60efad8d3773309bd057528c8a042b0efd02664691615db18bb3ef95f3a7c5d5b11814405a4f1d96d8d30b78a3f952ba711a4a930278aea10b161b46d000000000000000000000000000000000000000000000000000000006597c92e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0a467c8dc5eb10b33796175ac450a69c83dc29a912c311c9408afa657333c2d0076aeb5d57e933699f68b2f37c1d8657beefed10092e8308109fd62982185a708000000000000000000000000000000000000000000000000000000006597c93e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a042ecfea4b30af18c92b8b2ac4e635296485c993c0c59eddd5500f8408a2aba8a76aeb5d57e933699f68b2f37c1d8657beefed10092e8308109fd62982185a708000000000000000000000000000000000000000000000000000000006597c9500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0a2f030421764c3153fcc1dd67de17adb1c0926b9277dfd96da1f71a4cc46a60876aeb5d57e933699f68b2f37c1d8657beefed10092e8308109fd62982185a708000000000000000000000000000000000000000000000000000000006597c95c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a05d77a420ae13eb4d841f457f0ba1530ab25af355e3b2993f6c4a26418672701f76aeb5d57e933699f68b2f37c1d8657beefed10092e8308109fd62982185a708000000000000000000000000000000000000000000000000000000006597c9700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a032c8db56c7371978e958fc19ba50f83bc71e78270a8f5aa5ab2feca34f006b9476aeb5d57e933699f68b2f37c1d8657beefed10092e8308109fd62982185a708000000000000000000000000000000000000000000000000000000006597c9830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0c0667901144578f288172e0fc342f87981a8a2170f4dc850c16dd49a45fa4d10b825b8309422372e81fc59237b4d404d7ac87df2c76afe6ffae1e61f5713465f000000000000000000000000000000000000000000000000000000006597c9940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0884c6b30cd4448b38574f44c460b7a1627c832b33061c633314373766d4153c2b825b8309422372e81fc59237b4d404d7ac87df2c76afe6ffae1e61f5713465f000000000000000000000000000000000000000000000000000000006597c9a80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a03adb56257789f9f7adba0e3c4d75a8cd576568b62cf7cc4ae82151364c074a31b825b8309422372e81fc59237b4d404d7ac87df2c76afe6ffae1e61f5713465f000000000000000000000000000000000000000000000000000000006597c9b90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0de409db6ab84b199c251d4d58548ba2d9af7e2485297c82b91ff284e265d24cab825b8309422372e81fc59237b4d404d7ac87df2c76afe6ffae1e61f5713465f000000000000000000000000000000000000000000000000000000006597c9cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00ac3718249e789f247fa1fd290322899edc2387034e425c069a24bf07743dca78308f3d43167745e6fd70a01be6d883ad6cdf40f93b95ed0611e0e154d59107f000000000000000000000000000000000000000000000000000000006597c9d70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a02be80e4dcccb317e68c3d7521ed0f367ba7cd8cd734a639b78d6bb74638656178308f3d43167745e6fd70a01be6d883ad6cdf40f93b95ed0611e0e154d59107f000000000000000000000000000000000000000000000000000000006597c9e50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a04eab07c9f9cd525ce3a61c8aa3c8b48f4f5667a43ca7f82672a09fc7dd6121492ccb3ad0754b9f8bca78121f106cd6306a4e2e0dca37ca80bf5d6afc3ad5f9ed000000000000000000000000000000000000000000000000000000006597c9f80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0ba4d3cc5e22dd637c6db7e93fb34ff56a667aa318aa1eb840ac5c338901f9c832ccb3ad0754b9f8bca78121f106cd6306a4e2e0dca37ca80bf5d6afc3ad5f9ed000000000000000000000000000000000000000000000000000000006597ca090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a01809e5052a8e89fe042bd5aa0752de6615babaca5f9b9bdf301fe930d88137af2ccb3ad0754b9f8bca78121f106cd6306a4e2e0dca37ca80bf5d6afc3ad5f9ed000000000000000000000000000000000000000000000000000000006597ca170000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0552d870a1ba1f131502cb4578a25c0fba91885949179b18f6a2abb9576cea6e260969ef770bf491d75ffce96b5d5db34475f422e5a2c1494666fa19adb40a729000000000000000000000000000000000000000000000000000000006597ca280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0a529904b764bbe1f87d09bee8f72be7c0e6275838687bf8631deb874ec5ab26960969ef770bf491d75ffce96b5d5db34475f422e5a2c1494666fa19adb40a729000000000000000000000000000000000000000000000000000000006597ca3900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006974b58639a5f75db2325d1e186f936465430f12345a0753a3731bafa86700e7ad5336ae1f30da8850e5498cc84b2a1da71b83239ba07086bcb7ef2f9ec88e16021cb1a3f77364476988d978bc67b8d0db8743325048fb8587d5a4b4b3c31f3c9844af08d16ec07bcb880000000000000000000000000000000000000000000000")

	tx := types.NewTransaction(0, common.HexToAddress("095e7baea6a6c7c4c2dfeb977efac326af552d87"), big.NewInt(10), 50000, big.NewInt(10), txInput)
	seqReq, _ := client.unpackSequenceBatchesTx(tx)
	ret, _ := seqReq.marshal()

	req := client.newSignRequest(1, client.cfg.CustodialAssetsConfig.SequencerAddr, string(ret))
	mTx := monitoredTx{
		from: common.HexToAddress("d6dda5aa7749142b7fda3fe4662c9f346101b8a6"),
	}
	client.postSignRequestAndWaitResult(ctx, mTx, req)
}
